#################################################################
#								#
# Copyright (c) 2018-2025 YottaDB LLC and/or its subsidiaries.	#
# All rights reserved.						#
#								#
#	This source code contains the intellectual property	#
#	of its copyright holder(s), and is made available	#
#	under a license.  If you do not know the terms of	#
#	the license, please stop and do not read further.	#
#								#
#################################################################
image: yottadb/yottadb-base:latest-master

stages:
  - test
  - build
  - deploy

variables:
  # Default Go version to install in the docker build
  # Note: If GOLANG_VERSION below is bumped up in the future, you may also wish to consider bumping ./Dockerfile
  #       so that any developer using the Dockerfile has the same version.
  #       However, note that the actual Go versions tested against are specified in TEST_GO_VERSIONS below.
  GOLANG_VERSION: 1.24.0

before_script: |-
  apt-get update && apt-get install -y --no-install-recommends wget ca-certificates git g++ gcc libc6-dev make pkg-config && rm -rf /var/lib/apt/lists/*
  export GOPROXY=https://proxy.golang.org/cached-only
  export GOPATH=/go
  export GOBIN=${GOPATH}/bin
  export PATH=${GOBIN}:/usr/local/go/bin:$PATH
  wget -O go.tgz -q https://golang.org/dl/go${GOLANG_VERSION}.linux-amd64.tar.gz
  tar -C /usr/local -xzf go.tgz
  rm go.tgz
  go version
  export ydb_dist=/opt/yottadb/current
  mkdir -p $CI_PROJECT_DIR/artifacts


# ~~~ Unit tests

.unit_tests:
  stage: test
  script: &base_unit_test_script |-
    export YDB_GO_SKIP_TIMED_TESTS="yes"
    cd ${TEST_VERSION}
    go get -t
    latest=$(wget -qO - https://go.dev/VERSION?m=text | head -n1 | cut -c3-)
    versions="${TEST_GO_VERSIONS//latest/$latest}"
    versions=$(echo -e "${versions// /\\n}" | sort --version-sort --unique) # remove duplicates
    for ver in $versions; do
      go install golang.org/dl/go$ver@latest && go$ver download
      go$ver test -v
      # the following ls tests for the existence of the wildcard to prevent cp error when no file exists
      mkdir -p $CI_PROJECT_DIR/artifacts/go$ver
      ls /tmp/ydbgo* &>/dev/null && cp -r /tmp/ydbgo* $CI_PROJECT_DIR/artifacts/go$ver
      ls m_routines  &>/dev/null && cp -r m_routines  $CI_PROJECT_DIR/artifacts/go$ver
      find $CI_PROJECT_DIR/artifacts/go$ver
    done
    # Verify that bench tests run (avoids adding erroneous benchmarks) -- it's unnecessary to run them against every Go version in the loop above
    go$ver test -bench . -short -timeout 60s -benchtime 0.1s
  artifacts:
    paths:
      - artifacts
    expire_in: 7 days

v2_unit_tests:
  extends: .unit_tests
  variables:
    TEST_VERSION: v2
    # Test against the latest point release of Go in each major version since the version of Go specified in go.mod up to latest
    TEST_GO_VERSIONS: "1.24.0 latest"
  script:
    - *base_unit_test_script
    # Create temporary database
    - tmpdir=$(mktemp -d --tmpdir ydbgo_testapps_XXXXX)
    - export ydb_gbldir=$tmpdir/mumps.gld
    - $ydb_dist/mumps -run ^GDE change -seg DEFAULT -file=${ydb_gbldir/.gld/.dat}
    - $ydb_dist/mupip create
    - $ydb_dist/mupip extend -blocks=8192 DEFAULT  # more needed for pseudoBank.go
    # Verify that the mini-apps run
    - go run test/wordfreq.go <test/wordfreq_input.txt | diff - test/wordfreq_output.txt
    - go run test/pseudoBank.go --timeout=2 --verbose
    - rm -rf $tmpdir

v1_unit_tests:
  extends: .unit_tests
  variables:
    # Set version to . to test v1
    TEST_VERSION: .
    # Test against the release of Go specified in go.mod and also against the latest version of Go.
    # This will adequate rather than intermediate versions of Go since Go is intentionally designed for backward compatiblity.
    TEST_GO_VERSIONS: "1.18.10 latest"


# ~~~ Race detector tests

race_detector:
  stage: test
  script: |-
    # Test v1
    go get -t
    go test -v -race
    go test -v -asan
    # Test v2
    go get -C v2 -t
    go test -C v2 -v -race
    go test -C v2 -v -asan


# ~~~ Coverage tests

v2_coverage:
  stage: test
  variables:
    TEST_VERSION: v2
    COVERDIR: ${CI_PROJECT_DIR}/cover/${TEST_VERSION}
  script: |-
    make -C ${TEST_VERSION} coverage
    # Visualization instructions: https://docs.gitlab.com/ci/testing/code_coverage/?tab=Go
    go get github.com/boumenot/gocover-cobertura
    go install github.com/boumenot/gocover-cobertura
    (cd ${TEST_VERSION} && gocover-cobertura < ${COVERDIR}/coverage.cov > ${COVERDIR}/coverage.xml)
  # Capture output of go test `-covermode` switch above
  #   cf. https://docs.gitlab.com/ci/yaml/#coverage
  coverage: '/coverage: \d+(?:\.\d+)?/'
  artifacts:
    paths:
      - cover/${TEST_VERSION}/coverage.cov
      - cover/${TEST_VERSION}/coverage.html
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ${COVERDIR}/coverage.xml
    expire_in: 2 years  # default is 1 week but YDBGo can exist for a long time without change

v1_coverage:
  stage: test
  variables:
    # Set version to . to test v1
    TEST_VERSION: .
  script: |-
    mkdir -p $CI_PROJECT_DIR/cover/${TEST_VERSION}
    go get -C ${TEST_VERSION} -t
    go test -C ${TEST_VERSION} -covermode=count -coverprofile "$CI_PROJECT_DIR/cover/${TEST_VERSION}/coverage.cov"
    go tool -C ${TEST_VERSION} cover -func=$CI_PROJECT_DIR/cover/${TEST_VERSION}/coverage.cov
    go tool -C ${TEST_VERSION} cover -html=$CI_PROJECT_DIR/cover/${TEST_VERSION}/coverage.cov -o $CI_PROJECT_DIR/cover/${TEST_VERSION}/coverage.html
    # Visualization instructions: https://docs.gitlab.com/ci/testing/code_coverage/?tab=Go
    go get github.com/boumenot/gocover-cobertura
    go install github.com/boumenot/gocover-cobertura
    (cd ${TEST_VERSION} && gocover-cobertura < $CI_PROJECT_DIR/cover/${TEST_VERSION}/coverage.cov > $CI_PROJECT_DIR/cover/${TEST_VERSION}/coverage.xml)
  # Capture output of go test `-covermode` switch above
  #   cf. https://docs.gitlab.com/ci/yaml/#coverage
  coverage: '/coverage: \d+(?:\.\d+)?/'
  artifacts:
    paths:
      - cover/${TEST_VERSION}/coverage.cov
      - cover/${TEST_VERSION}/coverage.html
    reports:
      coverage_report:
        coverage_format: cobertura
        path: $CI_PROJECT_DIR/cover/${TEST_VERSION}/coverage.xml
    expire_in: 2 years  # default is 1 week but YDBGo can exist for a long time without change


commit-verify:
  image: ubuntu:24.04
  stage: test
  before_script: |-
    apt-get update -qq && apt-get install -y -qq git wget gnupg
  script: |-
    # Copy commit gpg key verify script to build directory and execute
    wget https://gitlab.com/YottaDB/DB/YDB/-/raw/master/ci/commit_verify.sh
    chmod +x commit_verify.sh
    ./commit_verify.sh scripts/needs_copyright.sh https://gitlab.com/YottaDB/Lang/YDBGo

lint_code:
  stage: test
  script: |-
    go install honnef.co/go/tools/cmd/staticcheck@latest
    staticcheck -checks inherit,-ST1017,-SA4006,-S1006,-S1005,-S1000,-S1008
    (cd v2; staticcheck -checks -SA1019)

error_codes:
  stage: test
  script: |-
    go generate
    git diff --exit-code error_codes.go || (echo "There is a difference between the latest YottaDB master and the currently committed error_codes.go, please run 'go generate' and commit error_codes.go" && exit 1)

build:
  stage: build
  script: |-
    go build -v
    go build -C v2 -v

pages:
  stage: deploy
  dependencies:
    - v1_coverage
    - v2_coverage
  script: |-
    mkdir $CI_PROJECT_DIR/public
    mv cover/coverage.html $CI_PROJECT_DIR/public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - master
